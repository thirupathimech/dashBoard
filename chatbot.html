<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Chatbot</title>
  <!-- Bootstrap CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" href="favicon.ico">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #74ebd5, #acb6e5);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Segoe UI', sans-serif;
    }
    .chat-container {
      width: 100%;
      max-width: 450px;
      height: 550px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.18);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .chat-header {
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-header h2 {
      color: #fff;
      margin: 0;
      font-size: 1.5rem;
    }
    .chat-body {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .chat-message {
      display: flex;
      flex-direction: column;
      max-width: 80%;
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .user-message {
      align-self: flex-end;
    }
    .bot-message {
      align-self: flex-start;
    }
    .message-bubble {
      padding: 10px 15px;
      border-radius: 18px;
      word-wrap: break-word;
      position: relative;
    }
    .user-message .message-bubble {
      background: #007bff;
      color: #fff;
      border-radius: 18px 18px 0 18px;
    }
    .bot-message .message-bubble {
      background: rgba(255, 255, 255, 0.3);
      color: #333;
      border-radius: 18px 18px 18px 0;
    }
    .message-time {
      font-size: 0.7rem;
      margin-top: 4px;
      color: rgba(255, 255, 255, 0.7);
      align-self: flex-end;
    }
    .bot-message .message-time {
      align-self: flex-start;
    }
    .chat-footer {
      padding: 10px;
      background: rgba(255, 255, 255, 0.2);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    .chat-footer form {
      display: flex;
      gap: 10px;
    }
    .chat-footer input {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.3);
      color: #333;
      outline: none;
    }
    .chat-footer button {
      padding: 10px 15px;
      border-radius: 20px;
    }
    .typing-indicator {
      display: none;
      align-self: flex-start;
      margin-bottom: 10px;
    }
    .typing-indicator.active {
      display: flex;
    }
    .typing-indicator span {
      height: 10px;
      width: 10px;
      background-color: rgba(255, 255, 255, 0.7);
      border-radius: 50%;
      display: inline-block;
      margin: 0 2px;
      animation: bounce 1.4s infinite ease-in-out both;
    }
    .typing-indicator span:nth-child(1) {
      animation-delay: -0.32s;
    }
    .typing-indicator span:nth-child(2) {
      animation-delay: -0.16s;
    }
    @keyframes bounce {
      0%, 80%, 100% { 
        transform: scale(0);
  } 40% { 
    transform: scale(1.0);
  }
}
.chat-actions {
  display: flex;
  gap: 5px;
  margin-top: 5px;
}
.chat-actions button {
  font-size: 0.8rem;
  padding: 3px 8px;
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: #fff;
}
.voice-btn {
  background: transparent;
  border: none;
  color: white;
  cursor: pointer;
}
.voice-btn.recording {
  color: red;
  animation: pulse 1.5s infinite;
}
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}
.rich-card {
  background: rgba(255, 255, 255, 0.15);
  border-radius: 10px;
  padding: 10px;
  margin-top: 5px;
  max-width: 100%;
}
.rich-card img {
  width: 100%;
  border-radius: 8px;
  margin-bottom: 5px;
}
.rich-card h5 {
  margin: 5px 0;
  color: white;
}
.rich-card p {
  margin: 0;
  font-size: 0.9rem;
  color: rgba(255, 255, 255, 0.8);
}
.home-button {
  position: fixed;
  box-shadow: 2px 3px 20px 0px;
  top: 1rem;
  left: 1rem;
  z-index: 999;
  width: 3rem;
  height: 3rem;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 0.75rem;
  transition: transform 0.3s ease;
}
.home-button:hover {
  transform: scale(1.1);
}
/* Scrollbar Styling */
.chat-body::-webkit-scrollbar {
  width: 8px;
}
.chat-body::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.3);
  border-radius: 10px;
}
.settings-button {
  background: transparent;
  border: none;
  color: white;
  cursor: pointer;
}
.modal-content {
  background: rgba(31, 38, 135, 0.8);
  backdrop-filter: blur(10px);
  color: white;
}
.modal-header, .modal-footer {
  border-color: rgba(255, 255, 255, 0.1);
}
.form-control, .form-select {
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}
.form-control::placeholder {
  color: rgba(255, 255, 255, 0.7);
}
</style>
</head>
<body>
  <button class="home-button" onclick="window.location.href='index.html'" title="Back to Home">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
    </svg>
  </button>
  
  <div class="chat-container">
    <div class="chat-header">
      <h2>MistyBot ðŸ˜Ž</h2>
      <div>
        <button class="voice-btn" id="voiceBtn" title="Voice Input">
          <i class="fas fa-microphone"></i>
        </button>
        <button class="settings-button" data-bs-toggle="modal" data-bs-target="#settingsModal" title="Settings">
          <i class="fas fa-cog"></i>
        </button>
      </div>
    </div>
    <div class="chat-body" id="chatBody">
      <div class="chat-message bot-message">
        <div class="message-bubble">Hi there! I'm Misty Bot, your advanced AI assistant. I can help with conversations, calculations, jokes, and more. Try asking me anything!</div>
        <div class="message-time">Just now</div>
      </div>
    </div>
    <div class="typing-indicator" id="typingIndicator">
      <div class="message-bubble">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
    <div class="chat-footer">
      <form id="chatForm">
        <input type="text" id="userInput" placeholder="Type your message..." required>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-paper-plane"></i>
        </button>
      </form>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="settingsModalLabel">Chatbot Settings</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="languageSelect" class="form-label">Language</label>
            <select class="form-select" id="languageSelect">
              <option value="en">English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="zh">Chinese</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="voiceSpeed" class="form-label">Voice Speed</label>
            <input type="range" class="form-range" id="voiceSpeed" min="0.5" max="2" step="0.1" value="1">
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="voiceEnabled" checked>
            <label class="form-check-label" for="voiceEnabled">Enable Voice Output</label>
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="saveHistory" checked>
            <label class="form-check-label" for="saveHistory">Save Chat History</label>
          </div>
          <button type="button" class="btn btn-danger" id="clearHistory">Clear Chat History</button>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveSettings">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS and Popper.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Get DOM elements
    const chatBody = document.getElementById('chatBody');
    const chatForm = document.getElementById('chatForm');
    const userInput = document.getElementById('userInput');
    const typingIndicator = document.getElementById('typingIndicator');
    const voiceBtn = document.getElementById('voiceBtn');
    const clearHistoryBtn = document.getElementById('clearHistory');
    const saveSettingsBtn = document.getElementById('saveSettings');
    const languageSelect = document.getElementById('languageSelect');
    const voiceSpeed = document.getElementById('voiceSpeed');
    const voiceEnabled = document.getElementById('voiceEnabled');
    const saveHistory = document.getElementById('saveHistory');

    // Initialize speech recognition and synthesis
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    const synthesis = window.speechSynthesis;

    // Settings
    let settings = {
      language: 'en',
      voiceSpeed: 1,
      voiceEnabled: true,
      saveHistory: true
    };

    // Conversation context
    let conversationContext = {
      lastTopic: null,
      userName: null,
      userMood: null,
      previousQuestions: []
    };

    // Load settings and history from localStorage
    function loadSettings() {
      const savedSettings = localStorage.getItem('mistyBotSettings');
      if (savedSettings) {
        settings = JSON.parse(savedSettings);
        languageSelect.value = settings.language;
        voiceSpeed.value = settings.voiceSpeed;
        voiceEnabled.checked = settings.voiceEnabled;
        saveHistory.checked = settings.saveHistory;
      }
      
      if (settings.saveHistory) {
        const chatHistory = localStorage.getItem('mistyBotHistory');
        if (chatHistory) {
          const history = JSON.parse(chatHistory);
          history.forEach(msg => {
            addMessageToChat(msg.sender, msg.text, msg.time, false);
          });
        }
      }
    }

    // Save settings to localStorage
    function saveSettingsToStorage() {
      settings.language = languageSelect.value;
      settings.voiceSpeed = parseFloat(voiceSpeed.value);
      settings.voiceEnabled = voiceEnabled.checked;
      settings.saveHistory = saveHistory.checked;
      
      localStorage.setItem('mistyBotSettings', JSON.stringify(settings));
    }

    // Save message to history
    function saveMessageToHistory(sender, text, time) {
      if (!settings.saveHistory) return;
      
      let history = [];
      const savedHistory = localStorage.getItem('mistyBotHistory');
      if (savedHistory) {
        history = JSON.parse(savedHistory);
      }
      
      history.push({ sender, text, time });
      
      // Keep only last 50 messages
      if (history.length > 50) {
        history = history.slice(-50);
      }
      
      localStorage.setItem('mistyBotHistory', JSON.stringify(history));
    }

    // Add message to chat
    function addMessageToChat(sender, text, time, save = true) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${sender}-message`;
      
      const bubbleDiv = document.createElement('div');
      bubbleDiv.className = 'message-bubble';
      bubbleDiv.textContent = text;
      
      const timeDiv = document.createElement('div');
      timeDiv.className = 'message-time';
      timeDiv.textContent = time;
      
      messageDiv.appendChild(bubbleDiv);
      messageDiv.appendChild(timeDiv);
      
      chatBody.appendChild(messageDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
      
      if (save) {
        saveMessageToHistory(sender, text, time);
      }
    }

    // Add rich card to chat
    function addRichCardToChat(title, description, imageUrl, actions) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'chat-message bot-message';
      
      const bubbleDiv = document.createElement('div');
      bubbleDiv.className = 'message-bubble';
      
      const cardDiv = document.createElement('div');
      cardDiv.className = 'rich-card';
      
      if (imageUrl) {
        const img = document.createElement('img');
        img.src = imageUrl;
        cardDiv.appendChild(img);
      }
      
      if (title) {
        const titleEl = document.createElement('h5');
        titleEl.textContent = title;
        cardDiv.appendChild(titleEl);
      }
      
      if (description) {
        const descEl = document.createElement('p');
        descEl.textContent = description;
        cardDiv.appendChild(descEl);
      }
      
      if (actions && actions.length > 0) {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'chat-actions';
        
        actions.forEach(action => {
          const btn = document.createElement('button');
          btn.textContent = action.text;
          btn.addEventListener('click', () => {
            userInput.value = action.action;
            chatForm.dispatchEvent(new Event('submit'));
          });
          actionsDiv.appendChild(btn);
        });
        
        cardDiv.appendChild(actionsDiv);
      }
      
      bubbleDiv.appendChild(cardDiv);
      messageDiv.appendChild(bubbleDiv);
      
      const timeDiv = document.createElement('div');
      timeDiv.className = 'message-time';
      timeDiv.textContent = getCurrentTime();
      messageDiv.appendChild(timeDiv);
      
      chatBody.appendChild(messageDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
      
      saveMessageToHistory('bot', `[Card: ${title}] ${description}`, getCurrentTime());
    }

    // Get current time
    function getCurrentTime() {
      const now = new Date();
      return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Enhanced response patterns with actions
    const responsePatterns = [
      // Greetings
      {
        patterns: ['hi', 'hello', 'hey', 'howdy', 'greetings'],
        responses: [
          "Hey there! How can I help you today?",
          "Hello! Nice to see you again.",
          "Hi! What's on your mind?",
          "Greetings! How are you feeling today?"
        ],
        actions: ['How are you?', 'Tell me a joke', 'What can you do?']
      },
      // How are you
      {
        patterns: ['how are you', 'how do you do', 'how\'s it going'],
        responses: [
          "I'm doing great, thanks for asking! I'm here to help you with whatever you need.",
          "I'm functioning perfectly! Ready to assist you with questions, calculations, or just a friendly chat.",
          "All systems operational! How about you?"
        ],
        actions: ['I\'m good', 'I\'m feeling down', 'Can you help me?']
      },
      // Help
      {
        patterns: ['help', 'what can you do', 'abilities', 'features'],
        responses: [
          "I can help with conversations, answer questions, do calculations, tell jokes, provide information, and much more. Just ask me anything!",
          "I'm your AI assistant! I can chat, calculate, tell jokes, give information, and even understand some emotions. What would you like to try?",
          "I have many capabilities: natural conversation, calculations, jokes, information lookup, and more. Feel free to explore!"
        ],
        actions: ['Tell me a joke', 'Calculate something', 'How\'s the weather?']
      },
      // Jokes
      {
        patterns: ['joke', 'funny', 'laugh', 'humor'],
        responses: [
          "Why don't scientists trust atoms? Because they make up everything!",
          "I told my computer I needed a break, and it said 'No problem, I'll go to sleep.'",
          "Why did the scarecrow win an award? He was outstanding in his field!"
        ],
        actions: ['Another joke', 'That\'s funny', 'Tell me a riddle']
      },
      // Calculations
      {
        patterns: ['calculate', 'math', 'add', 'subtract', 'multiply', 'divide'],
        responses: [
          "I can help with calculations! Just give me a math problem like 'What is 25 + 17?'",
          "Math is my specialty! Try asking something like 'Calculate 15% of 80' or 'What is 12 Ã— 8?'"
        ],
        actions: ['What is 25 + 17?', 'Calculate 15% of 80', 'What is 12 Ã— 8?']
      },
      // Weather
      {
        patterns: ['weather', 'temperature', 'rain', 'sunny', 'forecast'],
        responses: [
          "I don't have access to real-time weather data, but I can tell you about weather patterns or suggest you check a weather app for your location.",
          "For current weather information, I'd recommend checking a weather service. Is there something else I can help with?"
        ],
        actions: ['Tell me about climate', 'What causes rain?', 'Never mind']
      },
      // Portfolio
      {
        patterns: ['portfolio', 'projects', 'work', 'experience'],
        responses: [
          "This chatbot is a great addition to any portfolio! It showcases frontend skills, UI/UX design, and interactive features.",
          "Your portfolio could highlight this chatbot as an example of your web development skills. You might also want to add more features like API integration or a backend!"
        ],
        actions: ['How to improve it?', 'Add more features', 'Show me examples']
      },
      // Emotions
      {
        patterns: ['sad', 'depressed', 'unhappy', 'feeling down'],
        responses: [
          "I'm sorry to hear you're feeling down. Remember that tough times don't last, but tough people do. Is there something specific that's bothering you?",
          "I'm here for you. Sometimes just talking about what's bothering you can help. Would you like to share what's on your mind?",
          "I'm sorry you're feeling this way. Remember to be kind to yourself. Would a distraction like a joke or interesting fact help?"
        ],
        actions: ['Tell me something positive', 'I need advice', 'Just listen']
      },
      {
        patterns: ['happy', 'excited', 'great', 'wonderful'],
        responses: [
          "That's wonderful to hear! Happiness is contagious, and you're spreading some good vibes right now!",
          "I love hearing that! What's making you feel so great today?",
          "Awesome! It's great when you're in a good mood. Is there something special happening?"
        ],
        actions: ['Tell me good news', 'Share a happy story', 'Keep the good vibes']
      },
      // Farewell
      {
        patterns: ['bye', 'goodbye', 'see you', 'later', 'farewell'],
        responses: [
          "Goodbye! It was great chatting with you. Feel free to come back anytime!",
          "See you later! Remember, I'm here whenever you need me.",
          "Until next time! Take care and have a wonderful day!"
        ],
        actions: ['Come back soon', 'One more thing', 'Bye!']
      },
      // Thanks
      {
        patterns: ['thank', 'thanks', 'appreciate', 'grateful'],
        responses: [
          "You're welcome! I'm happy to help. Is there anything else you need?",
          "My pleasure! Don't hesitate to ask if you need anything else.",
          "Glad I could help! Feel free to reach out anytime."
        ],
        actions: ['You\'re helpful', 'More questions', 'That\'s all']
      },
      // Default
      {
        patterns: [],
        responses: [
          "I'm not sure I understand. Could you rephrase that or try asking in a different way?",
          "That's interesting! I'm not sure how to respond to that. Can you tell me more?",
          "I'm still learning! Could you try asking something else or use the help command to see what I can do?"
        ],
        actions: ['Help', 'Try again', 'Never mind']
      }
    ];

    // Find best matching response
    function findBestResponse(userText) {
      const lowerText = userText.toLowerCase();
      
      // Check for calculations
      if (lowerText.match(/calculate|what is|solve|compute/i) && lowerText.match(/[0-9+\-*/%]/)) {
        return {
          response: calculateResult(userText),
          isCalculation: true
        };
      }
      
      // Check for name extraction
      const nameMatch = userText.match(/my name is (\w+)/i);
      if (nameMatch) {
        conversationContext.userName = nameMatch[1];
        return {
          response: `Nice to meet you, ${conversationContext.userName}! I'll remember that.`,
          isName: true
        };
      }
      
      // Check for pattern matches
      for (const pattern of responsePatterns) {
        for (const p of pattern.patterns) {
          if (lowerText.includes(p)) {
            const response = pattern.responses[Math.floor(Math.random() * pattern.responses.length)];
            return {
              response,
              actions: pattern.actions
            };
          }
        }
      }
      
      // Default response
      const defaultPattern = responsePatterns.find(p => p.patterns.length === 0);
      const response = defaultPattern.responses[Math.floor(Math.random() * defaultPattern.responses.length)];
      return {
        response,
        actions: defaultPattern.actions
      };
    }

    // Calculate math expressions
    function calculateResult(text) {
      try {
        // Extract mathematical expression
        const mathExpression = text.match(/([0-9+\-*/%.() ]+)/);
        if (!mathExpression) return "I couldn't find a valid calculation in your message.";
        
        // Safe evaluation using Function constructor
        const result = Function('"use strict"; return (' + mathExpression[0] + ')')();
        
        return `The result is: ${result}`;
      } catch (error) {
        return "I couldn't calculate that. Please check your expression and try again.";
      }
    }

    // Process user input
    function processUserInput(userText) {
      const time = getCurrentTime();
      
      // Add user message
      addMessageToChat('user', userText, time);
      
      // Show typing indicator
      typingIndicator.classList.add('active');
      
      // Simulate processing time
      setTimeout(() => {
        // Hide typing indicator
        typingIndicator.classList.remove('active');
        
        // Get response
        const { response, actions, isCalculation, isName } = findBestResponse(userText);
        
        // Add bot response
        if (isCalculation || isName) {
          addMessageToChat('bot', response, getCurrentTime());
        } else {
          addMessageToChat('bot', response, getCurrentTime());
          
          // Add action buttons if available
          if (actions && actions.length > 0) {
            const lastMessage = chatBody.lastElementChild;
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'chat-actions';
            
            actions.forEach(action => {
              const btn = document.createElement('button');
              btn.textContent = action;
              btn.addEventListener('click', () => {
                userInput.value = action;
                chatForm.dispatchEvent(new Event('submit'));
              });
              actionsDiv.appendChild(btn);
            });
            
            lastMessage.querySelector('.message-bubble').appendChild(actionsDiv);
          }
        }
        
        // Speak response if voice is enabled
        if (settings.voiceEnabled) {
          speakResponse(response);
        }
      }, 1000 + Math.random() * 1000); // Random delay between 1-2 seconds
    }

    // Text-to-speech
    function speakResponse(text) {
      if (!synthesis) return;
      
      synthesis.cancel(); // Cancel any ongoing speech
      
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = settings.voiceSpeed;
      utterance.pitch = 1;
      utterance.volume = 1;
      
      synthesis.speak(utterance);
    }

    // Handle form submission
    chatForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const userText = userInput.value.trim();
      if (!userText) return;
      
      processUserInput(userText);
      
      // Clear input
      userInput.value = '';
    });

    // Voice recognition
    if (recognition) {
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = settings.language === 'en' ? 'en-US' : settings.language;
      
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        userInput.value = transcript;
        chatForm.dispatchEvent(new Event('submit'));
      };
      
      recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        voiceBtn.classList.remove('recording');
      };
      
      recognition.onend = function() {
        voiceBtn.classList.remove('recording');
      };
    }

    // Voice button click
    voiceBtn.addEventListener('click', function() {
      if (!recognition) {
        alert('Speech recognition is not supported in your browser.');
        return;
      }
      
      if (voiceBtn.classList.contains('recording')) {
        recognition.stop();
        voiceBtn.classList.remove('recording');
      } else {
        recognition.start();
        voiceBtn.classList.add('recording');
      }
    });

    // Settings modal events
    saveSettingsBtn.addEventListener('click', function() {
      saveSettingsToStorage();
      
      // Update recognition language if it exists
      if (recognition) {
        recognition.lang = settings.language === 'en' ? 'en-US' : settings.language;
      }
      
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
      modal.hide();
    });

    // Clear history
    clearHistoryBtn.addEventListener('click', function() {
      if (confirm('Are you sure you want to clear all chat history?')) {
        localStorage.removeItem('mistyBotHistory');
        
        // Clear current chat
        while (chatBody.firstChild) {
          chatBody.removeChild(chatBody.firstChild);
        }
        
        // Add welcome message
        addMessageToChat('bot', 'Chat history cleared. How can I help you today?', getCurrentTime());
      }
    });

    // Allow Enter key to submit
    userInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        chatForm.dispatchEvent(new Event('submit'));
      }
    });

    // Initialize on load
    window.addEventListener('load', function() {
      loadSettings();
    });
  </script>
</body>
</html>
